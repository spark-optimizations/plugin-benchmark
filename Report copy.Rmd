---
title: "Spark Join Optimizations"
author: "Shabbir Hussain, Manthan Thakar, Tirthraj Parmar"
date: "December 5, 2017"
output:
  html_document:
    df_print: paged
  pdf_document:
    fig_crop: no
    fig_width: 5
    latex_engine: xelatex
geometry: left=1cm,right=1cm,top=1cm,bottom=2cm
---

```{r setup, echo=F, results='hide', message=F, warning=F, cache=F}
library("ggplot2")
library("tidyr")
library("knitr")
library("kableExtra")
library("scales")
library("plyr")
library("microbenchmark")
library("reshape2")
library("readr")
library("tm")
library("SnowballC")
library("wordcloud")
library("RColorBrewer")
library("grid")
library("gridBase")
library("gridExtra")
library("dplyr")
library("stringr")

g_legend<-function(aGplot){
    tmp <- ggplot_gtable(ggplot_build(aGplot))
    leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
    legend <- tmp$grobs[[leg]]
    legend
}
```


```{r echo=F, cache=TRUE, results='hide'}
data <- read.csv('results/run_timing.csv', sep="\t", header = FALSE)
data <- data[, c("V1", "V3", "V4")]
```

```{r fig.align="center", fig.cap="Figure 4 - Compilation Timings", fig.height=3, fig.width=3, echo=F, message=F, warning=F, cache=F, results='hide'}
dataRun <- subset(data, (substring(data$V1, 0, 3) == "run") & data$V3=="real" & (str_sub(data$V1, -5) == "22_22"))

ggplot(data=dataRun, aes(x=V1, y=V4, fill="black")) +
      geom_violin() + 
      labs(x="", y="Time (sec)", title="Plugin vs Control")  +
      theme_bw() + theme(plot.title = element_text(size=8), legend.position = "none") +
      scale_y_continuous(limits = c(1, 3)) +
      scale_fill_grey() + 
      scale_color_grey()
```

```{r echo=F, message=F, warning=F, cache=F, results='hide'}
show_run_plots <- function(metricType, metricName, unit, scale=1, round=0, fNum){
  gen_plot <- function(df, title){
    ggplot(data=df, aes(x=reorder(as.factor(Tot), Tot), y=reorder(as.factor(Used), Used), fill=Median)) +
        geom_tile(width=1, height=1) + 
        scale_fill_gradient(low="white", high="red", name=metricName, limits=c(dMin, dMax),
                          labels=function(x) dollar_format(suffix=unit, prefix = "")(round(x/scale, 0))) +
        labs(x="Total # Columns", y="Used # Columns", title=title) + 
        theme_bw()
  }
  
  dataRun <- subset(data, (substring(data$V1, 0, 3) == "run") & data$V3==metricType)
  dataRun$V1 <- substring(dataRun$V1, 5)
  dataRun %>%
    group_by(V1) %>% 
    summarise(Mean=mean(V4), Median=median(V4), count = n()) %>%
    separate("V1", into = paste("V", 1:3, sep = "_")) -> dataRun
  
  colnames(dataRun) <- c("Type", "Tot", "Used", "Mean", "Median", "Count")
  dataRun$Type <- as.factor(dataRun$Type)
  dataRun$Tot  <- as.integer(dataRun$Tot)
  dataRun$Used <- as.integer(dataRun$Used)
  dataRun <- subset(dataRun, Tot!=0)
  dataRun <- dataRun %>% mutate(Type=ifelse(Type=="reg", "Control", "Plugin"))
  
  dfReg <- subset(dataRun, Type=="Control")
  dfPlu <- subset(dataRun, Type=="Plugin")
  
  dMin <- min(dataRun$Median)
  dMax <- max(dataRun$Median)

  # Individual HeatMaps
  pltR <- gen_plot(dfReg, "Control")
  pltP <- gen_plot(dfPlu, "Plugin")
  g1 <- arrangeGrob(pltR+guides(fill=FALSE), pltP+guides(fill=FALSE), nrow = 2)
  g2 <- arrangeGrob(g_legend(pltR), g1, ncol = 2, widths = c(1,4))
  
  ggplot(data=dataRun, aes(x=reorder(as.factor(Tot), Tot), y=reorder(as.factor(Used), Used), fill=Median)) +
        geom_tile(width=1, height=1) + 
        scale_fill_gradient(low="white", high="red", 
                            name=metricName, limits=c(dMin, dMax),  
                            labels=function(x) 
                              dollar_format(suffix=unit, prefix = "")(round(x/scale, round))) +
        labs(x="Total # Columns", 
             y="Used # Columns", 
             title=paste0("Fig ", fNum, ".1 Individual Execution"))  + 
        facet_grid(Type~., switch = "y") +
        theme_bw() + theme(legend.position="left", plot.title = element_text(size=8)) -> g1
  
  # Combined HeatMap
  dfAll <- merge(x = dfReg, y = dfPlu, by = c("Tot", "Used"), all = FALSE)
  dfAll$Fill <- round(((-dfAll$Median.y + dfAll$Median.x)*100/dfAll$Median.x), 0)

  ggplot(data=dfAll, aes(x=reorder(as.factor(Tot), Tot), y=reorder(as.factor(Used), Used), fill=Fill)) +
      geom_tile(width=1, height=1) + 
      scale_fill_gradient2(low="red", mid="ivory", high="green", midpoint=0, name="Delta",
                           labels=function(x) dollar_format(suffix = "%", prefix = "")(x)) +
      labs(x="Total # Columns", y=element_blank(), 
           title=paste0("Fig ", fNum, ".2 Plugin vs Control (Speedup)")) + 
      geom_text(aes(label=paste0(Fill, "%")),  size=2) +
      theme_bw() + theme(plot.title = element_text(size=8)) -> g3
  
  grid.arrange(g1, g3, ncol=2)
}
```

```{r fig.align="center", fig.cap="Figure 2 - Execution Time", fig.height=3, fig.width=10, cache=F,echo=F, results = 'asis', warning=F, message=F}
show_run_plots("real", metricName="Time", unit="ms", scale=1, round=1, fNum=2)
```


```{r fig.align="center", fig.cap="Figure 3 - Shuffled Data", fig.height=3, fig.width=10, cache=F,echo=F, results = 'asis', warning=F, message=F}
show_run_plots("shuffle", metricName="Shuffle", unit="kb", scale=1024, round=0, fNum=3)
```





```{r echo=F, cache=TRUE, results='hide'}
data <- read.csv('results/com_timing.csv', sep=" ", header = FALSE)
data <- data[, c("V1", "V2", "V3")]
data <- data %>% mutate(V1=ifelse(V1=="com_reg", "Control", "Plugin"))
```


```{r fig.align="center", fig.cap="Figure 4 - Compilation Timings", fig.height=3, fig.width=3, echo=F, message=F, warning=F, cache=F, results='hide'}
colnames(data) <- c("Type", "Metric", "Time")
data$Type <- as.factor(data$Type)
data$Time  <- as.integer(data$Time)

ggplot(data=data, aes(x=Type, y=Time, fill="black")) +
      geom_violin() + 
      labs(x="", y="Time (sec)", title="Plugin vs Control")  +
      theme_bw() + theme(plot.title = element_text(size=8), legend.position = "none") +
      scale_fill_grey() + 
      scale_color_grey()
```




















``{r echo=F, message=F, warning=F, cache=TRUE, results='hide'}
show_run_plots <- function(metricType, metricName, unit, scale=1){
  gen_plot <- function(df, title){
    ggplot(data=df, aes(x=reorder(as.factor(Tot), Tot), y=reorder(as.factor(Used), Used), fill=Median)) +
        geom_tile(width=1, height=1) + 
        scale_fill_gradient(low="white", high="red", name=metricName, limits=c(dMin, dMax),
                          labels=function(x) dollar_format(suffix=unit, prefix = "")(round(x/scale, 0))) +
        labs(x="Total # Columns", y="Used # Columns", title=title) + 
        theme_bw()
  }
  
  dataRun <- subset(data, (substring(data$V1, 0, 3) == "run") & data$V3==metricType)
  dataRun$V1 <- substring(dataRun$V1, 5)
  dataRun %>%
    group_by(V1) %>% 
    summarise(Mean=mean(V4), Median=median(V4), count = n()) %>%
    separate("V1", into = paste("V", 1:3, sep = "_")) -> dataRun
  
  colnames(dataRun) <- c("Type", "Tot", "Used", "Mean", "Median", "Count")
  dataRun$Type <- as.factor(dataRun$Type)
  dataRun$Tot  <- as.integer(dataRun$Tot)
  dataRun$Used <- as.integer(dataRun$Used)
  dataRun <- subset(dataRun, Tot!=0)
  
  dfReg <- subset(dataRun, Type=="reg")
  dfPlu <- subset(dataRun, Type=="plugin")
  
  dMin <- min(dataRun$Median)
  dMax <- max(dataRun$Median)

  # Individual HeatMaps
  pltR <- gen_plot(dfReg, "Control")
  pltP <- gen_plot(dfPlu, "Plugin")
  g1 <- arrangeGrob(pltR+guides(fill=FALSE), pltP+guides(fill=FALSE), nrow = 2)
  g2 <- arrangeGrob(g_legend(pltR), g1, ncol = 2, widths = c(1,4))
  
  dataRun <- dataRun %>% mutate(Type=ifelse(Type=="reg", "Control", "Plugin"))
  # Combined HeatMap
  dfAll <- merge(x = dfReg, y = dfPlu, by = c("Tot", "Used"), all = FALSE)
  dfAll$Fill <- round(((dfAll$Median.y - dfAll$Median.x)*100/dfAll$Median.x), 0)

  g3 <- ggplot(data=dfAll, aes(x=reorder(as.factor(Tot), Tot), y=reorder(as.factor(Used), Used), fill=Fill)) +
      geom_tile(width=1, height=1) + 
      scale_fill_gradient2(low="green", mid="ivory", high="red", midpoint=0, name="Delta",
                           labels=function(x) dollar_format(suffix = "%", prefix = "")(x)) +
      labs(x="Total # Columns", y="Used # Columns", title="Plugin vs control") + 
      geom_text(aes(label=paste0(Fill, "%")),  size=2) +
      theme_bw()
  
  grid.arrange(g2, g3, ncol=2)
}
``
``{r echo=F, message=F, warning=F, cache=TRUE, results='hide'}
show_run_plots <- function(metricType, metricName, unit, scale=1, round=0){


  dataRun <- subset(data, (substring(data$V1, 0, 3) == "run") & data$V3==metricType)
  dataRun$V1 <- substring(dataRun$V1, 5)
  dataRun %>%
    group_by(V1) %>% 
    summarise(Mean=mean(V4), Median=median(V4), count = n()) %>%
    separate("V1", into = paste("V", 1:3, sep = "_")) -> dataRun
  
  colnames(dataRun) <- c("Type", "Tot", "Used", "Mean", "Median", "Count")
  dataRun$Type <- as.factor(dataRun$Type)
  dataRun$Tot  <- as.integer(dataRun$Tot)
  dataRun$Used <- as.integer(dataRun$Used)
  dataRun <- subset(dataRun, Tot!=0)
  
  dfReg <- subset(dataRun, Type=="reg")
  dfPlu <- subset(dataRun, Type=="plugin")
  
  dMin <- min(dataRun$Median)
  dMax <- max(dataRun$Median)

  # Individual HeatMaps
  dataRun <- dataRun %>% mutate(Type=ifelse(Type=="reg", "Control", "Plugin"))
  
  g1 <- ggplot(data=dataRun, aes(x=reorder(as.factor(Tot), Tot), y=reorder(as.factor(Used), Used), fill=Median)) +
        geom_tile(width=1, height=1) + 
        scale_fill_gradient(low="white", high="red", name=metricName, limits=c(dMin, dMax),  labels=function(x) dollar_format(suffix=unit, prefix = "")(round(x/scale, round))) +
        labs(x="Total # Columns", y="Used # Columns") + 
        facet_grid(.~Type) +
        coord_fixed(ratio = 1) +
        theme_bw() + theme(legend.position="left")
  
  # Combined HeatMap
  
  dfAll <- merge(x = dfReg, y = dfPlu, by = c("Tot", "Used"), all = FALSE)
  dfAll$Fill <- round(((dfAll$Median.y - dfAll$Median.x)*100/dfAll$Median.x), round)

  g3 <- ggplot(data=dfAll, aes(x=reorder(as.factor(Tot), Tot), y=reorder(as.factor(Used), Used), fill=Fill)) +
      geom_tile(width=1, height=1) + 
      scale_fill_gradient2(low="green", mid="ivory", high="red", midpoint=0, name="Delta",
                           labels=function(x) dollar_format(suffix = "%", prefix = "")(x)) +
      labs(x="Total # Columns", y="Used # Columns", title="Plugin vs control") + 
      geom_text(aes(label=paste0(Fill, "%")),  size=2) +
      coord_fixed(ratio = 1) +
      theme_bw() 
  
  grid.arrange(g1, g3, ncol=2, widths=c(2,1))
}
``
    
``{r fig.align="center", fig.cap="Figure 2", fig.height=4, fig.width=8, cache=TRUE,echo=F, results = 'asis', warning=F, message=F}
show_run_plots(metricType="real", metricName="Time", unit="ms", scale=1, round=1)
``


``{r fig.align="center", fig.cap="Figure 2", fig.height=4, fig.width=8, cache=TRUE,echo=F, results = 'asis', warning=F, message=F}
show_run_plots("shuffle", metricName="Shuffle", unit="mb", scale=1024*1024)
``




``{r echo=F, message=F, warning=F, cache=TRUE, results='hide'}
dataRun <- subset(data, (substring(data$V1, 0, 3) == "run") & data$V3=="shuffle")
dataRun$V1 <- substring(dataRun$V1, 5)
dataRun %>%
  group_by(V1) %>% 
  summarise(Mean=mean(V4), Median=median(V4), count = n()) %>%
  separate("V1", into = paste("V", 1:3, sep = "_")) -> dataRun

colnames(dataRun) <- c("Type", "Tot", "Used", "BytesMean", "BytesMedian")
dataRun$Tot <- as.integer(dataRun$Tot)
dataRun$Used <- as.integer(dataRun$Used)
dataRun <- subset(dataRun, Tot!=0)

dfReg <- subset(dataRun, Type=="reg")
dfPlu <- subset(dataRun, Type=="plugin")

dMin <- min(dataRun$BytesMedian)
dMax <- max(dataRun$BytesMedian)

gen_plot <- function(df, title){
  ggplot(data=df, aes(x=reorder(as.factor(Tot), Tot), y=reorder(as.factor(Used), Used), fill=BytesMedian)) +
      geom_tile(width=1, height=1) + 
      scale_fill_gradient(low="white", high="red", name="Shuffle", limits=c(dMin, dMax), 
                          labels=function(x) dollar_format(suffix = "mb", prefix = "")(round(x/(1024*1024), 0))) +
      labs(x="Total # Columns", y="Used # Columns", title=title) + 
      theme_bw()
}

``{r fig.align="center", fig.cap="Figure 1", cache=TRUE, echo=F, results = 'hide', warning=F, message=F}



gen_plot <- function(df, title){
  ggplot(data=df, aes(x=reorder(as.factor(Tot), Tot), y=reorder(as.factor(Used), Used), fill=BytesMedian)) +
      geom_tile(width=1, height=1) + 
      scale_fill_gradient(low="white", high="red", name="Shuffle", limits=c(20*1024*1024, 30*1024*1024), labels=function(x) dollar_format(suffix = "mb", prefix = "")(round(x/(1024*1024), 0))) +
      labs(x="Total # Columns", y="Used # Columns", title=title) + 
      theme_bw()
}
pltR <- gen_plot(dfReg, "Control")
pltP <- gen_plot(dfPlu, "Plugin")

#grid.arrange(pltR+guides(fill=FALSE), pltP+guides(fill=FALSE), pltLeg , ncol=3, widths=c(4,4,1))
grid.arrange(pltR, pltP, ncol=2, widths=c(1,1))
``
